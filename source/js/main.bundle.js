(()=>{"use strict";var e={d:(t,r)=>{for(var o in r)e.o(r,o)&&!e.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:r[o]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};e.d({},{T:()=>ne,U:()=>oe});const t="https://22.javascript.pages.academy/keksobooking",r={X:35.675,Y:139.75},o={PALACE:"Дворец",FLAT:"Квартира",HOUSE:"Дом",BUNGALOW:"Бунгало"},n={bungalow:0,flat:1e3,house:5e3,palace:1e4},c={1:[2],2:[1,2],3:[0,1,2],100:[3]},a=["wifi","dishwasher","parking","washer","elevator","conditioner"],s=document.querySelector("#card").content.querySelector(".popup");(e=>{let t=0;e.forEach((e=>{e.setAttribute("data-name",a[t]),t++}))})(s.querySelector(".popup__features").querySelectorAll(".popup__feature"));const i=e=>{const t=s.cloneNode(!0);t.querySelector(".popup__title").textContent=e.offer.title,t.querySelector(".popup__text--address").textContent=e.offer.address,t.querySelector(".popup__text--price").innerHTML=`${e.offer.price} <span>₽/ночь</span>`,t.querySelector(".popup__type").textContent=o[e.offer.type.toUpperCase()],t.querySelector(".popup__description").textContent=e.offer.description,t.querySelector(".popup__avatar").src=e.author.avatar,t.querySelector(".popup__text--capacity").textContent=`${e.offer.rooms} комнаты для ${e.offer.guests} гостей`,t.querySelector(".popup__text--time").textContent=`Заезд после ${e.offer.checkin}, выезд до ${e.offer.checkout}`,e.offer.rooms&&e.offer.guests||t.querySelector(".popup__text--capacity").classList.add("hidden"),parseInt(e.offer.checkin)&&parseInt(e.offer.checkout)||t.querySelector(".popup__text--time").classList.add("hidden");const r=t.querySelector(".popup__features"),n=r.querySelectorAll(".popup__feature");var c,a,i;c=n,a=e.offer.features,(i=r).innerHTML="",a.forEach((e=>{c.forEach((t=>{t.dataset.name===e&&i.appendChild(t)}))}));const l=t.querySelector(".popup__photos"),d=l.querySelector(".popup__photo");var u,p,y;return u=d,p=e.offer.photos,(y=l).innerHTML="",p.forEach((e=>{const t=u.cloneNode(!0);t.src=e,y.appendChild(t)})),t},l=500,d={low:[0,1e4],middle:[1e4,5e4],high:[5e4,1e7],any:[0,1e7]},u=document.querySelector(".map__filters"),p=u.querySelector("#housing-type"),y=u.querySelector("#housing-price"),m=u.querySelector("#housing-rooms"),g=u.querySelector("#housing-guests"),f=u.querySelector("#housing-features"),h=(e,t)=>{te(t);const r=e.length<10?e.length:10;return ee(oe,e,r)};let v="any",S="any",q="any",b="any",A=[],x=[],E=[],k=[],w=[];const C=document.querySelector("main"),I="Escape",T=()=>{oe.setView({lat:r.X,lng:r.Y},10)},$=(e,t)=>{const r=e.querySelectorAll("option");for(let e=0;e<r.length;e++)r[e].removeAttribute("selected","");r[t].setAttribute("selected","")},j=e=>{e.reset();const t=e.querySelectorAll("option");for(let e=0;e<t.length;e++)t[e].removeAttribute("selected","");K(),$(p,0),$(y,0),$(m,0),$(g,0),te(k),k=h(x,E),w=x,v="any",S="any",q="any",b="any",A=[],u.reset(),ne.setLatLng([r.X,r.Y]).update()},O=["gif","jpg","jpeg","png"],z=(e,t)=>{let r=t.querySelector("img");return e.addEventListener("change",(()=>{t.contains(r)||(r=document.createElement("img"),r.setAttribute("alt","Фото жилья"),r.setAttribute("width",40),r.setAttribute("height",44),t.style.display="flex",t.style.alignItems="center",t.style.padding="0 15px",t.appendChild(r));const o=e.files[0],n=o.name.toLowerCase();if(O.some((e=>n.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{r.src=e.result})),e.readAsDataURL(o)}})),r},U=e=>{e.querySelectorAll("option").forEach((e=>{e.disabled=!0}))},P=(e,t)=>{const r=t.querySelectorAll("option");e.forEach((e=>{r[e].disabled=!1}))},X="image/*",Y=document.querySelector(".ad-form"),F=Y.querySelector("#type"),N=Y.querySelector(".ad-form__element--time"),D=N.querySelector("#timein"),H=N.querySelector("#timeout"),M=Y.querySelector("#price"),R=Y.querySelector("#room_number"),V=Y.querySelector("#capacity"),W=Y.querySelector("#address"),B=(Y.querySelector(".ad-form__submit"),z(document.querySelector("#avatar"),document.querySelector(".ad-form-header__preview"))),G=document.querySelector("#images"),J=document.querySelector(".ad-form__photo");z(G,J);const K=()=>{var e;e=r,W.setAttribute("readonly","readonly"),W.value=`${e.X}, ${e.Y}`,F[1].setAttribute("selected",""),M.setAttribute("min",n.flat),M.setAttribute("placeholder",n.flat),R[0].setAttribute("selected",""),D[0].setAttribute("selected",""),H[0].setAttribute("selected",""),$(V,2),U(V),P(c[1],V),B.src="img/muffin-grey.svg";const t=J.querySelector("img");J.contains(t)&&J.removeChild(t)};Y.querySelector(".ad-form__reset").addEventListener("click",(e=>{e.preventDefault(),j(Y),T()}));const Q=e=>{e.classList.add("ad-form--disabled");for(let t=0;t<e.children.length;t++)e.children[t].setAttribute("disabled","disabled")},Z=e=>{e.classList.remove("ad-form--disabled");for(let t=0;t<e.children.length;t++)e.children[t].removeAttribute("disabled","disabled")},ee=(e,t,r)=>{const o=[];for(let n=0;n<r;n++){const r=i(t[n]),c=L.icon({iconUrl:"img/pin.svg",iconSize:[52,52],iconAnchor:[26,52]}),a=L.marker({lat:t[n].location.lat,lng:t[n].location.lng},{icon:c});a.addTo(e).bindPopup(r),o.push(a)}return o},te=e=>{e.forEach((e=>{e.remove()}))},re=e=>{if(e.ok)return e;throw new Error};Y.addEventListener("submit",(e=>{e.preventDefault();const r=new FormData(e.target);fetch(t,{method:"POST",body:r}).then(re).then((()=>{(()=>{const e=document.querySelector("#success").content.querySelector(".success").cloneNode(!0);e.style.zIndex=1e3,C.append(e);const t=()=>{e.remove(),document.removeEventListener("click",t),document.removeEventListener("keydown",r)},r=e=>{e.key===I&&t()};document.addEventListener("click",t),document.addEventListener("keydown",r)})(),j(Y),T()})).catch((()=>(()=>{const e=document.querySelector("#error").content.querySelector(".error").cloneNode(!0);e.style.zIndex=1e3,C.append(e);const t=()=>{e.remove(),document.removeEventListener("click",t),document.removeEventListener("keydown",r)},r=e=>{e.key===I&&t()};document.addEventListener("click",t),document.addEventListener("keydown",r)})()))})),Q(Y),Q(u),(()=>{K(),Y.setAttribute("method","POST"),Y.setAttribute("action","https://22.javascript.pages.academy/keksobooking"),Y.setAttribute("enctype","multipart/form-data");const e=Y.querySelector("#avatar");e.setAttribute("required",""),e.setAttribute("accept",X);const t=Y.querySelector("#title");t.setAttribute("required",""),t.setAttribute("minlength",30),t.setAttribute("maxlength",100);const r=Y.querySelector("#price");r.setAttribute("required",""),r.setAttribute("max",1e6);const o=Y.querySelector("#images");o.setAttribute("required",""),o.setAttribute("accept",X),F.addEventListener("input",(e=>{const t=e.target.options.selectedIndex,r=e.target.value;$(e.target,t),M.min=n[r],M.placeholder=n[r]})),N.addEventListener("change",(e=>{const t=e.target.options.selectedIndex,r=e.target.value;$(D,t),$(H,t),H.value=r,D.value=r})),R.addEventListener("input",(e=>{const t=e.target.options.selectedIndex,r=e.target.value;$(e.target,t),U(V),P(c[r],V),$(V,c[r][0])})),V.addEventListener("input",(e=>{const t=e.target.options.selectedIndex;$(e.target,t)}))})();const oe=(()=>{const e=L.map("map-canvas").on("load",(()=>{Z(Y)})).setView({lat:r.X,lng:r.Y},10);return L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(e),e})(),ne=(e=>{const t=L.icon({iconUrl:"img/main-pin.svg",iconSize:[60,80],iconAnchor:[30,80]}),o=L.marker({lat:r.X,lng:r.Y},{draggable:!0,icon:t}).addTo(e);return o.on("move",(e=>{const t=e.target.getLatLng().lat.toFixed(5),r=e.target.getLatLng().lng.toFixed(5);document.querySelector("#address").value=`${t}, ${r}`})),o})(oe);var ce;ce=e=>{const t=ee(oe,e,10);Z(u),((e,t)=>{w=t,x=t,E=e,k=e;const r=()=>w=t.filter((e=>{return"any"===(t=v)||e.offer.type===t;var t})).filter((e=>((e,t)=>{const r=d[t][0],o=d[t][1];return e.offer.price>=r&&e.offer.price<o||"any"===t})(e,S))).filter((e=>{return"any"===(t=q)||t===String(e.offer.rooms);var t})).filter((e=>{return"any"===(t=b)||t===String(e.offer.guests);var t})).filter((e=>((e,t)=>{for(const r of t)if(!e.offer.features.includes(r))return!1;return!0})(e,A)));p.addEventListener("change",_.debounce((e=>{v=e.target.value;const t=e.target.options.selectedIndex;$(p,t),r(),k=h(w,k)}),l)),y.addEventListener("change",_.debounce((e=>{S=e.target.value;const t=e.target.options.selectedIndex;$(y,t),r(),k=h(w,k)}),l)),m.addEventListener("change",_.debounce((e=>{q=e.target.value;const t=e.target.options.selectedIndex;$(m,t),r(),k=h(w,k)}),l)),g.addEventListener("change",_.debounce((e=>{b=e.target.value;const t=e.target.options.selectedIndex;$(g,t),r(),k=h(w,k)}),l)),f.addEventListener("change",_.debounce((()=>{A=Array.from(f.querySelectorAll("input:checked")).map((e=>e.value)),r(),k=h(w,k)}),l))})(t,e)},fetch("https://22.javascript.pages.academy/keksobooking/data").then((e=>e.json())).then((e=>ce(e))).catch((()=>(e=>{const t=document.querySelector("#map-canvas"),r=document.createElement("div");r.style.zIndex=1e3,r.style.position="absolute",r.style.right="10px",r.style.top="10px",r.style.color="white",r.style.padding="10px 3px",r.style.margin="10px auto",r.style.fontSize="12px",r.style.textAlign="right",r.style.backgroundColor="red",r.textContent="Не удалось загрузить данные с сервера. Повторите попытку позже",t.append(r),setTimeout((()=>{r.remove()}),5e3)})()))})();